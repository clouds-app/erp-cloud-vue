<template>
  <div>
    <editWindow
      class="cl-edit-supplier"
      :title="actionLableName"
      v-model="showWindow"
      :fullscreen="false"
      width="90%"
      :loading="!isLoaddingDone"
      @on-ok="formDataSubmit()"
    >
      <Form
        ref="formDataInfo"
        :show-message="true"
        :model="formDataInfo"
        :rules="ruleValidate"
        :label-width="110"
      >
        <Row :gutter="18">
          <Col span="24">
            <Row :gutter="18">
              <Col span="6">
                <FormItem label="供应商编号" prop="purCode">
                  <referenceField
                    v-model="formDataInfo.purCode"
                    :form-name="frommastername"
                    :id="formDataInfo.id"
                    maxlength="20"
                    :disabled="detailDisabled"
                    placeholder="请输入供应商"
                  ></referenceField>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="供应商名称" prop="purName">
                  <Input
                    v-model="formDataInfo.purName"
                    maxlength="20"
                    :disabled="detailDisabled"
                    placeholder="请输入供应商"
                  ></Input>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="简称" prop="shortName">
                  <Input
                    v-model="formDataInfo.shortName"
                    maxlength="20"
                    :disabled="detailDisabled"
                    placeholder="请输入简称"
                  ></Input>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="英文名称" prop="enName">
                  <Input
                    v-model="formDataInfo.enName"
                    maxlength="20"
                    :disabled="detailDisabled"
                    placeholder="请输入英文名称"
                  ></Input>
                </FormItem>
              </Col>
            </Row>
          </Col>
          <Col span="6">
            <FormItem label="电话" prop="vTel">
              <Input
                v-model="formDataInfo.vTel"
                maxlength="20"
                :disabled="detailDisabled"
                placeholder="请输入电话"
              ></Input>
            </FormItem>
          </Col>

          <Col span="6">
            <FormItem label="传真" prop="vFax">
              <Input
                type="number"
                v-model="formDataInfo.vFax"
                maxlength="20"
                :disabled="detailDisabled"
                placeholder="请输入传真"
              ></Input>
            </FormItem>
          </Col>
          <Col span="12">
            <Row>
              <Col span="8" style="padding-top: 5px; width:65%">
                <FormItem label="所属地区" prop="areaIdsList">
                  <Cascader
                    :data="cityCascader"
                    :disabled="detailDisabled"
                    :load-data="getCityCascader"
                    v-model="formDataInfo.areaIdsList"
                    maxlength="20"
                    placeholder="请输入所属地区"
                  ></Cascader>
                </FormItem>
              </Col>
              <Col span="4">
                <FormItem label prop="addrDetail" style="margin-left: -90%; width:100%">
                  <Input
                    style="width: 200px;;"
                    v-model="formDataInfo.addrDetail"
                    :disabled="detailDisabled"
                    maxlength="20"
                    placeholder="请输入详细地址"
                  ></Input>
                </FormItem>
              </Col>
            </Row>
          </Col>
          <Col span="6">
            <FormItem label="业务类型" prop="vType">
              <optionSearch
                :disabled="detailDisabled"
                @onChange="optionOnChange"
                :defaultItem="formDataInfo.vType"
                :loaddingDataWhen="showWindow"
                formKey="vType"
                query="vType"
              />
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="供应商等级" prop="vLevel">
              <optionSearch
                @onChange="optionOnChange"
                :disabled="detailDisabled"
                :default-item="formDataInfo.vLevel"
                :loaddingDataWhen="showWindow"
                formKey="vLevel"
                query="vLevel"
              />
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="纸板采购模式" prop="poType">
              <optionSearch
                @onChange="optionOnChange"
                :disabled="detailDisabled"
                :default-item="formDataInfo.poType"
                :loaddingDataWhen="showWindow"
                formKey="poType"
                query="poType"
              />
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="纸板金额" prop="priceAreaMode">
              =报价*总面积&nbsp;&nbsp;
              <Checkbox
                v-model="formDataInfo.priceAreaMode"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder
              ></Checkbox>
            </FormItem>
          </Col>
          <Col span="24">
            <Row :gutter="18">
              <Col span="6">
                <FormItem label="结算货币" prop="coinCode">
                  <popup
                      v-model="formDataInfo.coinCode"
                      field-name="coinCode"
                      :disabled="detailDisabled"
                      popup-name="CoinSingleBox"
                      :fill-model.sync="formDataInfo"
                      render-fields="coinId,coinCode,coinName"
                      from-fields="id,coinCode,coinName"
                      :suffix="true"
                      :suffix-model="formDataInfo.coinName"
                      @on-fill="coinCodevalidator"
                      :query-params="{}"
                    />
                  <!-- <optionSearch
                    @onChange="optionOnChange"
                    :disabled="detailDisabled"
                    :defaultItem="formDataInfo.coinId"
                    :loaddingDataWhen="showWindow"
                    formKey="coinId"
                    query="coinId"
                  /> -->
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="计量单位" prop="unitId">
                  <!-- <Input v-model="formDataInfo.unitId" maxlength="20" placeholder="请输入计量单位"></Input> -->
                  <optionSearch
                    @onChange="optionOnChange"
                    :disabled="detailDisabled"
                    :defaultItem="formDataInfo.unitId"
                    :loaddingDataWhen="showWindow"
                    formKey="unitId"
                    query="unitId"
                  />
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="单价小数位" prop="ctDot">
                  <InputNumber
                    v-model="formDataInfo.ctDot"
                    :disabled="detailDisabled"
                    :formatter="value => ` ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                    :parser="value => value.replace(/\$\s?|(,*)/g, '')"
                    style="width:100%"
                    maxlength="20"
                    placeholder="请输入单价小数位"
                  ></InputNumber>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="金额小数位" prop="amtDot">
                  <InputNumber
                    v-model="formDataInfo.amtDot"
                    :disabled="detailDisabled"
                    :formatter="value => ` ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                    :parser="value => value.replace(/\$\s?|(,*)/g, '')"
                    style="width:100%"
                    maxlength="20"
                    placeholder="请输入金额小数位"
                  ></InputNumber>
                </FormItem>
              </Col>
            </Row>
          </Col>
          <Col span="24">
            <Row :gutter="18">
              <Col span="6">
                <FormItem label="付款方式" prop="payCode">
                  <div>
                    <popup
                      v-model="formDataInfo.payCode"
                      field-name="payCode"
                      :disabled="detailDisabled"
                      popup-name="PayTypeSingleBox"
                      :fill-model.sync="formDataInfo"
                      render-fields="payId,payCode,payName,monthDays"
                      from-fields="id,payCode,payName,payDays"
                      :suffix="true"
                      :suffix-model="formDataInfo.payName"
                      :query-params="{}"
                      @on-fill="payCodevalidator"
                    />
                  </div>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="月结方式" prop="arpType">
                  <optionSearch
                    @onChange="optionOnChange"
                    :disabled="detailDisabled"
                    v-model="formDataInfo.arpType"
                    :loaddingDataWhen="showWindow"
                    formKey="arpType"
                    query="arpType"
                  />
                </FormItem>
              </Col>
             
              <Col span="6">
                <FormItem label="月结天数" prop="monthDays">
                  <InputNumber
                    v-model="formDataInfo.monthDays"
                    :disabled="detailDisabled"
                    :formatter="value => ` ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                    :parser="value => value.replace(/\$\s?|(,*)/g, '')"
                    style="width:100%"
                    maxlength="20"
                    placeholder="请输入月结天数"
                  ></InputNumber>
                </FormItem>
              </Col>
              <Col span="6">
                <FormItem label="月结终止日" prop="monthEnd">
                  <InputNumber
                    v-model="formDataInfo.monthEnd"
                    :disabled="detailDisabled"
                    :formatter="value => ` ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                    style="width:100%"
                    :parser="value => value.replace(/\$\s?|(,*)/g, '')"
                    maxlength="20"
                    placeholder="请输入月结终止日"
                  ></InputNumber>
                </FormItem>
              </Col>
            </Row>
          </Col>
          <Col span="6">
            <FormItem label="联系人" prop="vContractor">
              <Input
                v-model="formDataInfo.vContractor"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder="请输入联系人"
              ></Input>
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="折扣%" prop="discount">
              <InputNumber
                v-model="formDataInfo.discount"
                :disabled="detailDisabled"
                :formatter="value => ` ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                :parser="value => value.replace(/\$\s?|(,*)/g, '')"
                style="width:100%"
                maxlength="20"
                placeholder="请输入折扣%"
              ></InputNumber>
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="税别" prop="taxTP">
              <optionSearch
                @onChange="optionOnChange"
                :disabled="detailDisabled"
                :defaultItem="formDataInfo.taxTP"
                :loaddingDataWhen="showWindow"
                formKey="taxTP"
                query="taxTP"
              />
            </FormItem>
          </Col>

          <Col span="6">
            <FormItem label="税率%" prop="taxRate">
              <Input
                @on-change="taxRateMessage"
                v-model="formDataInfo.taxRate"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder="请输入税率%"
              ></Input>
            </FormItem>
          </Col>
          <!-- 联系人电话 -->
          <Col span="6">
            <FormItem label="联系人电话" prop="vContractorTel">
              <Input
                v-model="formDataInfo.vContractorTel"
                :disabled="detailDisabled"
                maxlength="20"
                type="number"
                placeholder="请输入联系人电话"
              ></Input>
            </FormItem>
          </Col>

          <Col span="6">
            <FormItem label="开户银行" prop="backName">
              <Input
                v-model="formDataInfo.backName"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder="请输入开户银行"
              ></Input>
            </FormItem>
          </Col>
          <Col span="6">
            <FormItem label="银行账号" prop="bankNo">
              <Input
                v-model="formDataInfo.bankNo"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder="请输入银行账号"
              ></Input>
            </FormItem>
          </Col>

          <Col span="6">
            <FormItem label="税号" prop="taxLicence">
              <Input
                v-model="formDataInfo.taxLicence"
                :disabled="detailDisabled"
                maxlength="20"
                placeholder="请输入税号"
              ></Input>
            </FormItem>
          </Col>

          <Col span="12" style="margin-bottom: 10px; margin-top: 10px;">
            <FormItem label="备注:" prop="remark">
              <Input
                v-model="formDataInfo.remark"
                :disabled="detailDisabled"
                maxlength="100"
                placeholder="请输入备注..."
              ></Input>
            </FormItem>
          </Col>
        </Row>
      </Form>
    </editWindow>
  </div>
</template>

<script>
/**
 * @desc edit-dept 描述
 * 所有重要 可以重用的方法 放在了基类,继承即可用重复使用 dyBaseMixins,
 * 可以根据需求重写所需的方法:
 *
 * @params 参数
 *
 * @return 返回
 *
 * @author Andy Huang
 *
 * @created 2019/11/20 17:07:54
 */
import referenceField from "@/components/referenceField/referenceField";
import editBaseMixins from "../../mixins/edit";
import popup from "@/components/popup/popup";
import optionSearch from "../../components/optionSearch";
import request from "@/libs/request";
import { customValidator, uniqueValidator } from "@/libs/validator";
import { deepCopy } from "view-design/src/utils/assist";

const default_formDataInfo = {
  payCode:'',
  vType: "0",
  payId: "0",
  payName: '',
  arpType: "0",
  vLevel: "A",
  taxTP: "I",
  areaIdsList: [],
  addrDetail: "",
  amtDot: 2,
  poType: "",
  areaIds: "",
  backName: "",
  bankNo: "",
  coinId:'',
  coinCode: "",
  coinName: "",
  ctDot: 2,
  curyCode: "",
  discount: 100,
  enName: "",
  iisAudit: 0,
  monthDays: 30,
  monthEnd: 31,
  pointj: 0,
  pointw: 0,
  priceAreaMode: 0,
  purCode: "",
  purName: "",
  remark: "",
  shortName: "",
  status: 1,
  taxLicence: "",
  taxRate: 0,
  vContractor: "",
  vContractorTel: "",
  vFax: "",
  vTel: "",
  unitId: ""
};
export default {
  name: "edit-supplier",
  mixins: [editBaseMixins],
  components: {
    optionSearch,
    popup,
    referenceField,
    deepCopy
  },

  data() {
    return {
      frommastername: "purSupplierFm",
      actionSubtitle: "供应商", // 当前操作副标题
      requestBaseUrl: "/purchase/supplier", // 请求 查询 操作的基础路径
      formDataInfo:deepCopy(default_formDataInfo), // 防止添加和更新数据提交发生冲突
      // 需要验证的数据
      ruleValidate: {
        vTel: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["phone"],
            fieldDesc: "电话"
          }
        ],
        ctDot: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "单价小数位"
          }
        ],
        amtDot: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "金额小数位"
          }
        ],
        discount: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "折扣%"
          }
        ],
        monthDays: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "月结天数"
          }
        ],
        monthEnd: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "月结终止日"
          }
        ],
        taxRate: [
          {
            validator: customValidator,
            trigger: "blur",
            customRule: ["mustDouble"],
            fieldDesc: "税率%"
          }
        ],
        purCode: [
          { required: true, message: "供应商编号不能为空", trigger: "blur" }
        ],
        purName: [
          { required: true, message: "供应商名称不能为空", trigger: "blur" }
        ],
        shortName: [
          { required: true, message: "简称不能为空", trigger: "blur" }
        ],
        payCode: [
          { required: true, message: "付款方式不能为空", trigger: "blur" }
        ],
        coinCode: [
          { required: true, message: "结算货币不能为空", trigger: "blur" }
        ],
      },
      cityCascader: [],
      cityCascaderCount: 0
    };
  },
  created() {
    //获取纸板采购模式默认值
    let IsSmallQty = this.$params.IsSmallQty;
    default_formDataInfo.poType = IsSmallQty;
    request.post("/bas/area/list", { pid: 0 }, { pid: 0 }).then(res => {
      res.forEach(item => {
        item["children"] = [];
      });
      this.cityCascader = res;
    });
    let unit = this.$params.Unit;
    if (unit === "1:厘米" || unit === "2:毫米") {
      default_formDataInfo.unitId = "1:平方米";
    } else {
      default_formDataInfo.unitId = "0:千平方英寸";
    }
  },
  methods: {
    payCodevalidator(){
      this.$refs['formDataInfo'].validateField('payCode',err=>{
      })
    },
    // 结算货币回调事件
    coinCodevalidator(){
      // this.$refs['formDataInfo'].validateField('coinCode','payCode',err=>{})
      this.$refs['formDataInfo'].validateField('coinCode',err=>{
      })
    },
    //税率提示
    taxRateMessage() {
      if (this.formDataInfo.taxRate > 17) {
        this.$Message.warning("税率过高请注意");
      }
    },
    getCityCascader(item, callback) {
      // debugger;
      item.loading = true;
      request
        .post(
          "/bas/area/list",
          { pid: item.value, name: item.label },
          { pid: item.value, name: item.label }
        )
        .then(res => {
          // this.cityCascaderCount++;
          // console.log(this.cityCascaderCount)
          if (res != null) {
            // debugger;
            res.forEach(item => {
              item["children"] = [];
            });
            delete item.loading;
            item.children = res;
          }
          item.loading = false;
          callback();
        });
    },
    // 重写父类,添加时候,清空数据
    HandleFormDataInfo() {
      // debugger
      this.$refs["formDataInfo"].resetFields();
      this.formDataInfo = deepCopy(default_formDataInfo)
    },
    //关闭窗口触发
    closeActionTigger() {},
    //打开窗口触发
    openActionTigger() {}
  }
};
</script>

<style>
.cl-edit-supplier .ivu-select-item {
  display: block;
}
</style>
